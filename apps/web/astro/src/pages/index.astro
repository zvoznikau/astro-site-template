---
import '../styles/global.css'
import { brand } from '../config/brand'

// Import all block components
import Header from '../components/sections/Header.astro'
import Hero from '../components/sections/Hero.astro'
import SocialProof from '../components/sections/SocialProof.astro'
import Features from '../components/sections/Features.astro'
import HowItWorks from '../components/sections/HowItWorks.astro'
import Pricing from '../components/sections/Pricing.astro'
import FAQ from '../components/sections/FAQ.astro'
import AppStoreDescription from '../components/sections/AppStoreDescription.astro'
import CTABand from '../components/sections/CTABand.astro'
import Footer from '../components/sections/Footer.astro'
import ImagePause from '../components/sections/ImagePause.astro'

// Block component mapping
const blockMap = {
  Header,
  Hero,
  SocialProof,
  Features,
  HowItWorks,
  Pricing,
  FAQ,
  AppStoreDescription,
  CTABand,
  Footer,
  ImagePause,
}

// Get block order from config
const blockOrder = brand.pages.index.blocks

// Build blocks with image pauses
const blocksWithPauses: Array<{ type: string; name?: string; props?: any }> = []
blockOrder.forEach((blockName, index) => {
  blocksWithPauses.push({ type: 'block', name: blockName })
  
  // Check if there's an image pause after this block
  const pause = brand.images?.pauses?.find((p) => p.after === blockName && p.src)
  if (pause) {
    blocksWithPauses.push({
      type: 'image',
      props: {
        src: pause.src,
        alt: pause.alt,
        type: pause.type,
      },
    })
  }
})

// Generate JSON-LD for SEO
const websiteJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: brand.name,
  url: brand.seo.canonical,
  description: brand.seo.description,
}

const organizationJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: brand.name,
  url: brand.seo.canonical,
  contactPoint: {
    '@type': 'ContactPoint',
    email: brand.contact.email,
    contactType: 'customer service',
  },
}

const faqJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: brand.faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
}
---
<html lang="en" data-theme={brand.theme.default} class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Theme color for browser UI (matches site background) -->
    <meta name="theme-color" content="#581c87" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#581c87" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#581c87" />
    <!-- Safari/iOS status bar -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <title>{brand.seo.title}</title>
    <meta name="description" content={brand.seo.description} />
    <meta name="keywords" content={brand.seo.keywords.join(', ')} />
    <link rel="canonical" href={brand.seo.canonical} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={brand.seo.canonical} />
    <meta property="og:title" content={brand.seo.title} />
    <meta property="og:description" content={brand.seo.description} />
    <meta property="og:image" content={brand.seo.ogImage} />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={brand.seo.canonical} />
    <meta property="twitter:title" content={brand.seo.title} />
    <meta property="twitter:description" content={brand.seo.description} />
    <meta property="twitter:image" content={brand.seo.ogImage} />
    
    <!-- Analytics -->
    {brand.analytics.googleAnalytics !== 'GA_MEASUREMENT_ID_PLACEHOLDER' && (
      <>
        <script
          async
          src={`https://www.googletagmanager.com/gtag/js?id=${brand.analytics.googleAnalytics}`}
        ></script>
        <script
          set:html={`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${brand.analytics.googleAnalytics}');
          `}
        />
      </>
    )}
    {brand.analytics.bingVerification !== 'BING_VERIFICATION_CODE_PLACEHOLDER' && (
      <meta name="msvalidate.01" content={brand.analytics.bingVerification} />
    )}
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(websiteJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
  </head>

  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white antialiased bg-fixed">
    <main class="relative">
      {
        blocksWithPauses.map((item) => {
          if (item.type === 'block' && item.name) {
            const BlockComponent = blockMap[item.name]
            if (BlockComponent) {
              return <BlockComponent />
            }
          } else if (item.type === 'image' && item.props) {
            return <ImagePause {...item.props} />
          }
          return null
        })
      }
    </main>
  </body>
</html>
