---
import { brand } from '../../config/brand'
import ThemeToggle from '../ui/ThemeToggle.astro'
import AppStoreBadge from '../ui/AppStoreBadge.astro'
---

<header id="main-header" class="fixed top-0 left-0 right-0 z-[9999] bg-base-100/90">
  <nav class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href="/" class="text-xl font-bold text-base-content hover:opacity-80 transition-opacity">
        {brand.name}
      </a>
      
      <div class="flex items-center gap-8">
        <!-- Desktop menu -->
        <div class="hidden lg:flex items-center gap-8">
          {brand.navigation.items.map((item) => {
            // Extract section ID from href (e.g., /#features -> features)
            const sectionId = item.href.replace(/^\/?#/, '');
            return (
              <a
                href={item.href}
                class="desktop-menu-item text-sm font-medium text-base-content/70 hover:text-base-content transition-all duration-200 relative"
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
                data-section={sectionId}
              >
                {item.label}
              </a>
            );
          })}
        </div>
        
        <!-- Desktop: Theme toggle and App Store badge -->
        <div class="hidden lg:flex items-center gap-4">
          <ThemeToggle />
          <AppStoreBadge href={brand.urls.appStore} size="sm" />
        </div>
        
        <!-- Mobile: Hamburger button -->
        <button
          id="mobile-menu-btn"
          class="lg:hidden p-2 text-base-content/70 hover:text-base-content"
          aria-label="Toggle menu"
        >
          <svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Mobile menu - outside header to blur content properly -->
<div id="mobile-menu" class="lg:hidden fixed inset-0 z-[10000] hidden">
  <!-- Overlay - blurs content below header, not the header itself -->
  <div id="menu-overlay" class="absolute top-[72px] left-0 right-0 bottom-0 bg-black/50 z-[1]"></div>
    
    <!-- Menu panel - above everything including header -->
    <div id="menu-panel" class="absolute top-0 right-0 h-full w-80 shadow-2xl flex flex-col z-[10001]" style="background-color: hsl(var(--b1) / 0.95);">
      <!-- Header with close button -->
      <div class="flex items-center justify-end p-4 flex-shrink-0">
        <button id="close-menu-btn" class="p-2 text-base-content/70 hover:text-base-content">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Menu items -->
      <nav class="flex-1 overflow-y-auto min-h-0 px-4 py-4">
        <ul class="space-y-0.5">
          <!-- Home link -->
          <li class="menu-item">
            <a
              href="/"
              class="block text-3xl font-medium text-base-content/70 hover:text-base-content py-4 px-5 rounded-xl hover:bg-base-content/10 transition-colors w-full"
            >
              Home
            </a>
          </li>
          
          {brand.navigation.items.map((item, index) => (
            <li class="menu-item" style={`animation-delay: ${(index + 1) * 50}ms;`}>
              <a
                href={item.href}
                class="block text-3xl font-medium text-base-content/70 hover:text-base-content py-4 px-5 rounded-xl hover:bg-base-content/10 transition-colors w-full"
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
              >
                {item.label}
              </a>
            </li>
          ))}
          
          <!-- App Store badge as menu item -->
          <li class="menu-item pt-2 mt-2" style={`animation-delay: ${(brand.navigation.items.length + 1) * 50}ms;`}>
            <div class="py-2 px-1">
              <AppStoreBadge href={brand.urls.appStore} size="sm" />
            </div>
          </li>
        </ul>
      </nav>
      
      <!-- Footer with Theme toggle -->
      <div class="px-4 pb-6 pt-4 flex-shrink-0">
        <div class="flex justify-center">
          <ThemeToggle />
        </div>
      </div>
    </div>
  </div>

<script>
  (function() {
    const menuBtn = document.getElementById('mobile-menu-btn');
    const closeBtn = document.getElementById('close-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const menuPanel = document.getElementById('menu-panel');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');
    
    if (!menuBtn || !mobileMenu || !menuOverlay || !menuPanel) return;
    
    let isOpen = false;
    
    function openMenu() {
      if (isOpen) return;
      isOpen = true;
      
      // Show menu container
      mobileMenu.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      menuIcon.classList.add('hidden');
      closeIcon.classList.remove('hidden');
      
      // Trigger smooth animations
      requestAnimationFrame(() => {
        menuPanel.style.transform = 'translateX(0)';
        menuOverlay.style.opacity = '1';
      });
      
      // Reset and trigger menu items animation with delay
      setTimeout(() => {
        const menuItems = mobileMenu.querySelectorAll('.menu-item');
        menuItems.forEach((item, index) => {
          item.style.animation = 'none';
          // Force reflow
          void item.offsetWidth;
          item.style.animation = `menu-item-fade-in 0.3s ease-out ${index * 50}ms forwards`;
        });
      }, 100);
    }
    
    function closeMenu() {
      if (!isOpen) return;
      isOpen = false;
      
      // Smooth close animation
      menuPanel.style.transform = 'translateX(100%)';
      menuOverlay.style.opacity = '0';
      
      // Reset menu items animation
      const menuItems = mobileMenu.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        item.style.animation = 'none';
      });
      
      // Hide menu after animation
      setTimeout(() => {
        mobileMenu.classList.add('hidden');
        document.body.style.overflow = '';
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
      }, 300);
    }
    
    menuBtn.addEventListener('click', () => {
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeMenu);
    }
    
    menuOverlay.addEventListener('click', closeMenu);
    
    // Close on link click (but not on theme toggle)
    const menuLinks = mobileMenu.querySelectorAll('nav a');
    menuLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
    
    // Theme toggle is handled by its own script, no need to prevent closing here
    // The stopPropagation is already in ThemeToggle component
    
    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
      }
    });
    
    // Initialize - ensure menu is closed on page load
    function initMenu() {
      if (isOpen) return;
      mobileMenu.classList.add('hidden');
      menuPanel.style.transform = 'translateX(100%)';
      menuOverlay.style.opacity = '0';
      isOpen = false;
    }
    
    // Initialize immediately
    initMenu();
    
    // Also ensure on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (!isOpen) initMenu();
      });
    }
    
    // Final check on page load
    window.addEventListener('load', () => {
      if (!isOpen) initMenu();
    });
  })();
  
  // Optimized scroll handlers with throttling
  (function() {
    const header = document.getElementById('main-header');
    const menuItems = document.querySelectorAll('.desktop-menu-item[data-section]');
    
    if (!header) return;
    
    const threshold = window.innerHeight;
    let ticking = false;
    let lastScrollY = window.scrollY;
    
    // Prepare sections for menu highlighting
    let sections = [];
    if (menuItems.length > 0) {
      sections = Array.from(menuItems).map(item => {
        const sectionId = item.getAttribute('data-section');
        const section = document.getElementById(sectionId);
        return { item, section, id: sectionId };
      }).filter(({ section }) => section !== null);
    }
    
    function updateHeaderShadow(scrollY) {
      if (scrollY === 0) {
        header.style.boxShadow = 'none';
      } else if (scrollY < threshold) {
        const opacity = scrollY / threshold;
        const shadowIntensity = opacity * 0.25;
        header.style.boxShadow = `0 10px 15px -3px rgba(0, 0, 0, ${shadowIntensity}), 0 4px 6px -2px rgba(0, 0, 0, ${shadowIntensity * 0.5})`;
      } else {
        header.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
      }
    }
    
    function updateActiveMenuItem(scrollY) {
      if (sections.length === 0) return;
      
      const windowHeight = window.innerHeight;
      const headerHeight = 72;
      let activeSection = null;
      let maxVisible = 0;
      
      sections.forEach(({ section, id }) => {
        const rect = section.getBoundingClientRect();
        const sectionTop = rect.top + scrollY;
        const sectionHeight = rect.height;
        
        const visibleTop = Math.max(0, scrollY + headerHeight - sectionTop);
        const visibleBottom = Math.min(sectionHeight, scrollY + windowHeight - sectionTop);
        const visibleHeight = Math.max(0, visibleBottom - visibleTop);
        const visiblePercent = visibleHeight / sectionHeight;
        
        if (rect.top <= headerHeight + 100 && rect.bottom >= headerHeight && visiblePercent > maxVisible) {
          maxVisible = visiblePercent;
          activeSection = id;
        }
      });
      
      menuItems.forEach(item => {
        const sectionId = item.getAttribute('data-section');
        if (sectionId === activeSection) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    function handleScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const scrollY = window.scrollY;
          
          // Only update if scroll position changed significantly (performance optimization)
          if (Math.abs(scrollY - lastScrollY) > 5) {
            updateHeaderShadow(scrollY);
            updateActiveMenuItem(scrollY);
            lastScrollY = scrollY;
          }
          
          ticking = false;
        });
        ticking = true;
      }
    }
    
    // Initial check
    updateHeaderShadow(window.scrollY);
    updateActiveMenuItem(window.scrollY);
    
    // Single scroll listener with throttling
    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Also check on hash change
    if (menuItems.length > 0) {
      window.addEventListener('hashchange', () => {
        setTimeout(() => updateActiveMenuItem(window.scrollY), 100);
      });
    }
  })();
</script>

<style>
  #mobile-menu {
    display: none;
  }
  
  #mobile-menu:not(.hidden) {
    display: block;
  }
  
  #menu-panel {
    transform: translateX(100%);
    background-color: hsl(var(--b1) / 0.95) !important;
    position: absolute;
    top: 0;
    right: 0;
    height: 100vh;
    width: 20rem;
    max-height: 100vh;
    z-index: 10001 !important;
    transition: transform 0.3s ease-out;
    will-change: transform;
  }
  
  #menu-overlay {
    z-index: 1 !important;
    opacity: 0;
    transition: opacity 0.3s ease-out;
  }
  
  #main-header {
    transition: box-shadow 0.3s ease-in-out;
  }
  
  /* Menu items animation */
  .menu-item {
    opacity: 0;
    transform: translateX(20px);
    animation: menu-item-fade-in 0.3s ease-out forwards;
  }
  
  @keyframes menu-item-fade-in {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  /* Desktop menu items animation */
  .desktop-menu-item {
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
  }
  
  .desktop-menu-item:hover {
    transform: translateY(-1px);
  }
  
  .desktop-menu-item:active {
    transform: translateY(0);
  }
  
  .desktop-menu-item::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 1px;
    background: currentColor;
    transition: width 0.2s ease-out, left 0.2s ease-out, background-color 0.2s ease-out;
    transform: translateX(-50%);
  }
  
  .desktop-menu-item:hover::after {
    width: 80%;
    background: hsl(var(--p)); /* Purple gradient color for hover */
    height: 1px;
  }
  
  .desktop-menu-item.active::after {
    width: 80%;
    background: currentColor;
    height: 1px;
  }
  
  .desktop-menu-item.active:hover::after {
    background: hsl(var(--p)); /* Purple on hover even when active */
  }
  
  .desktop-menu-item.active {
    color: hsl(var(--bc));
  }
</style>
