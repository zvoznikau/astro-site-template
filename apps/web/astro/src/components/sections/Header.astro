---
import { brand } from '../../config/brand'
import ThemeToggle from '../ui/ThemeToggle.astro'
import AppStoreBadge from '../ui/AppStoreBadge.astro'
---

<header class="sticky top-0 z-[101] bg-transparent backdrop-blur-md border-b border-white/10">
  <nav class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href="/" class="text-xl font-bold text-base-content hover:opacity-80 transition-opacity">
        {brand.name}
      </a>
      
      <div class="flex items-center gap-8">
        <!-- Desktop menu -->
        <div class="hidden lg:flex items-center gap-8">
          {brand.navigation.items.map((item) => (
            <a
              href={item.href}
              class="text-sm font-medium text-base-content/70 hover:text-base-content transition-colors"
              target={item.external ? '_blank' : undefined}
              rel={item.external ? 'noopener noreferrer' : undefined}
            >
              {item.label}
            </a>
          ))}
        </div>
        
        <!-- Desktop: Theme toggle and App Store badge -->
        <div class="hidden lg:flex items-center gap-4">
          <ThemeToggle />
          <AppStoreBadge href={brand.urls.appStore} size="sm" />
        </div>
        
        <!-- Mobile: Hamburger button -->
        <button
          id="mobile-menu-btn"
          class="lg:hidden p-2 text-base-content/70 hover:text-base-content"
          aria-label="Toggle menu"
        >
          <svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Mobile menu - outside header to blur content properly -->
<div id="mobile-menu" class="lg:hidden fixed inset-0 z-[102] hidden">
  <!-- Overlay - blurs entire page content -->
  <div id="menu-overlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    
    <!-- Menu panel -->
    <div id="menu-panel" class="absolute top-0 right-0 h-full w-80 shadow-2xl flex flex-col" style="background-color: hsl(var(--b1) / 0.6); backdrop-blur-md;">
      <!-- Header with close button -->
      <div class="flex items-center justify-end p-4 flex-shrink-0">
        <button id="close-menu-btn" class="p-2 text-base-content/70 hover:text-base-content">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Menu items -->
      <nav class="flex-1 overflow-y-auto min-h-0 px-4 py-4">
        <ul class="space-y-0.5">
          {brand.navigation.items.map((item) => (
            <li>
              <a
                href={item.href}
                class="block text-3xl font-medium text-base-content/70 hover:text-base-content py-4 px-5 rounded-xl hover:bg-base-content/10 transition-colors w-full"
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
              >
                {item.label}
              </a>
            </li>
          ))}
          
          <!-- App Store badge as menu item -->
          <li class="pt-2 mt-2">
            <div class="py-2 px-1">
              <AppStoreBadge href={brand.urls.appStore} size="sm" />
            </div>
          </li>
        </ul>
      </nav>
      
      <!-- Footer with Theme toggle -->
      <div class="px-4 pb-6 pt-4 flex-shrink-0">
        <div class="flex justify-center">
          <ThemeToggle />
        </div>
      </div>
    </div>
  </div>

<script>
  (function() {
    const menuBtn = document.getElementById('mobile-menu-btn');
    const closeBtn = document.getElementById('close-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const menuPanel = document.getElementById('menu-panel');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');
    
    if (!menuBtn || !mobileMenu || !menuOverlay || !menuPanel) return;
    
    let isOpen = false;
    
    function openMenu() {
      if (isOpen) return;
      isOpen = true;
      
      // Show menu container
      mobileMenu.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      menuIcon.classList.add('hidden');
      closeIcon.classList.remove('hidden');
      
      // Show menu immediately (no animation)
      menuPanel.style.transform = 'translateX(0)';
      menuOverlay.style.opacity = '1';
    }
    
    function closeMenu() {
      if (!isOpen) return;
      isOpen = false;
      
      // Hide menu immediately (no animation)
      menuPanel.style.transform = 'translateX(100%)';
      menuOverlay.style.opacity = '0';
      mobileMenu.classList.add('hidden');
      
      document.body.style.overflow = '';
      menuIcon.classList.remove('hidden');
      closeIcon.classList.add('hidden');
    }
    
    menuBtn.addEventListener('click', () => {
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeMenu);
    }
    
    menuOverlay.addEventListener('click', closeMenu);
    
    // Close on link click (but not on theme toggle)
    const menuLinks = mobileMenu.querySelectorAll('nav a');
    menuLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
    
    // Theme toggle is handled by its own script, no need to prevent closing here
    // The stopPropagation is already in ThemeToggle component
    
    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
      }
    });
    
    // Initialize - ensure menu is closed on page load
    function initMenu() {
      if (isOpen) return;
      mobileMenu.classList.add('hidden');
      menuPanel.style.transform = 'translateX(100%)';
      menuOverlay.style.opacity = '0';
      isOpen = false;
    }
    
    // Initialize immediately
    initMenu();
    
    // Also ensure on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (!isOpen) initMenu();
      });
    }
    
    // Final check on page load
    window.addEventListener('load', () => {
      if (!isOpen) initMenu();
    });
  })();
</script>

<style>
  #mobile-menu {
    display: none;
  }
  
  #mobile-menu:not(.hidden) {
    display: block;
  }
  
  #menu-panel {
    transform: translateX(100%);
    background-color: hsl(var(--b1) / 0.6) !important;
    backdrop-filter: blur(12px);
    position: absolute;
    top: 0;
    right: 0;
    height: 100vh;
    width: 20rem;
    max-height: 100vh;
    z-index: 10;
  }
  
  #menu-overlay {
    z-index: 1;
  }
  
  #menu-overlay {
    opacity: 0;
  }
</style>
