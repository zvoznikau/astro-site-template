---
---

<div id="cookie-consent" class="hidden fixed bottom-0 left-0 right-0 z-50 p-4 sm:p-6">
  <div class="max-w-screen-xl mx-auto">
    <div class="bg-base-100/50 backdrop-blur-md border border-base-content/20 rounded-2xl shadow-2xl p-6 sm:p-8">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6">
        <div class="flex-1">
          <h3 class="text-lg font-bold text-base-content mb-2">Cookie Consent</h3>
          <p class="text-sm sm:text-base text-base-content/70 leading-relaxed">
            We use cookies to enhance your browsing experience, analyze site traffic, and personalize content. By clicking "Accept All", you consent to our use of cookies. 
            <a href="/cookies" class="text-blue-400 hover:text-blue-300 underline">Learn more</a>
          </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
          <button
            id="cookie-accept-all"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-lg transition-all duration-200 shadow-lg hover:shadow-blue-500/10 hover:-translate-y-0.5 active:translate-y-0 whitespace-nowrap"
          >
            Accept All
          </button>
          <button
            id="cookie-accept-essential"
            class="px-6 py-3 bg-base-content/10 hover:bg-base-content/20 text-base-content font-semibold rounded-lg transition-all duration-200 border border-base-content/20 hover:-translate-y-0.5 active:translate-y-0 whitespace-nowrap"
          >
            Essential Only
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const COOKIE_CONSENT_KEY = 'cookie-consent';
    const COOKIE_CONSENT_EXPIRY_DAYS = 365;
    
    const consentBanner = document.getElementById('cookie-consent');
    const acceptAllBtn = document.getElementById('cookie-accept-all');
    const acceptEssentialBtn = document.getElementById('cookie-accept-essential');
    
    if (!consentBanner || !acceptAllBtn || !acceptEssentialBtn) return;
    
    const isCookiesPage = window.location.pathname === '/cookies';
    let choiceMadeOnCookiesPage = false;
    
    // Check if user has already given consent
    function hasConsent() {
      try {
        return localStorage.getItem(COOKIE_CONSENT_KEY) !== null;
      } catch (e) {
        return false;
      }
    }
    
    // Clear consent
    function clearConsent() {
      try {
        localStorage.removeItem(COOKIE_CONSENT_KEY);
      } catch (e) {
        console.error('Failed to clear cookie consent:', e);
      }
    }
    
    // Save consent
    function saveConsent(acceptAll = false) {
      try {
        const consentData = {
          accepted: true,
          acceptAll: acceptAll,
          timestamp: new Date().toISOString(),
          expiry: new Date(Date.now() + COOKIE_CONSENT_EXPIRY_DAYS * 24 * 60 * 60 * 1000).toISOString()
        };
        localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(consentData));
        if (isCookiesPage) {
          choiceMadeOnCookiesPage = true;
        }
      } catch (e) {
        console.error('Failed to save cookie consent:', e);
      }
    }
    
    let bannerShown = false;
    
    // Show banner if no consent or on cookies page
    function showBanner() {
      if (bannerShown) return; // Prevent showing multiple times
      
      if (!hasConsent() || isCookiesPage) {
        consentBanner.classList.remove('hidden');
        consentBanner.classList.add('animate-slide-up');
        bannerShown = true;
      }
    }
    
    // Hide banner with slide-down animation
    function hideBanner() {
      // Remove slide-up animation if present
      consentBanner.classList.remove('animate-slide-up');
      // Add slide-down animation
      consentBanner.classList.add('animate-slide-down');
      // Hide after animation completes (0.3s)
      setTimeout(() => {
        consentBanner.classList.add('hidden');
        consentBanner.classList.remove('animate-slide-down');
      }, 300);
    }
    
    // Handle accept all
    acceptAllBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (isCookiesPage) {
        choiceMadeOnCookiesPage = true;
      }
      saveConsent(true);
      
      // Show feedback and hide banner
      if (isCookiesPage) {
        acceptAllBtn.textContent = '✓ Saved';
        acceptAllBtn.disabled = true;
        acceptAllBtn.classList.add('opacity-75', 'cursor-not-allowed');
        // Hide banner after showing feedback
        setTimeout(() => {
          hideBanner();
          acceptAllBtn.textContent = 'Accept All';
          acceptAllBtn.disabled = false;
          acceptAllBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }, 250);
      } else {
        hideBanner();
      }
      
      // Initialize analytics if needed
      if (typeof gtag !== 'undefined') {
        gtag('consent', 'update', {
          'analytics_storage': 'granted'
        });
      }
    });
    
    // Handle accept essential only
    acceptEssentialBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (isCookiesPage) {
        choiceMadeOnCookiesPage = true;
      }
      saveConsent(false);
      
      // Show feedback and hide banner
      if (isCookiesPage) {
        acceptEssentialBtn.textContent = '✓ Saved';
        acceptEssentialBtn.disabled = true;
        acceptEssentialBtn.classList.add('opacity-75', 'cursor-not-allowed');
        // Hide banner after showing feedback
        setTimeout(() => {
          hideBanner();
          acceptEssentialBtn.textContent = 'Essential Only';
          acceptEssentialBtn.disabled = false;
          acceptEssentialBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }, 250);
      } else {
        hideBanner();
      }
      
      // Disable analytics if needed
      if (typeof gtag !== 'undefined') {
        gtag('consent', 'update', {
          'analytics_storage': 'denied'
        });
      }
    });
    
    // Show banner logic based on page
    if (isCookiesPage) {
      // On cookies page, show immediately
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showBanner);
      } else {
        showBanner();
      }
    } else {
      // On main page, show/hide when scrolling
      let scrollTimeout = null;
      let isAnimating = false;
      
      function handleScroll() {
        // Debounce scroll events
        if (scrollTimeout) {
          clearTimeout(scrollTimeout);
        }
        
        scrollTimeout = setTimeout(() => {
          // If user already gave consent, don't show banner
          if (hasConsent()) return;
          
          // Don't toggle if animation is in progress
          if (isAnimating) return;
          
          // Show banner after scrolling at least 50% of viewport height
          // Hide when scrolling back to 30% (hysteresis to prevent flickering)
          const showThreshold = window.innerHeight * 0.5;
          const hideThreshold = window.innerHeight * 0.3;
          
          if (window.scrollY > showThreshold && !bannerShown) {
            isAnimating = true;
            showBanner();
            setTimeout(() => {
              isAnimating = false;
            }, 300);
          } else if (window.scrollY <= hideThreshold && bannerShown) {
            isAnimating = true;
            hideBanner();
            bannerShown = false; // Reset flag to allow showing again
            setTimeout(() => {
              isAnimating = false;
            }, 300);
          }
        }, 50); // Debounce delay
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          window.addEventListener('scroll', handleScroll, { passive: true });
        });
      } else {
        window.addEventListener('scroll', handleScroll, { passive: true });
      }
    }
    
    // On cookies page: reset consent if user leaves without making a choice
    if (isCookiesPage) {
      // Reset consent when leaving cookies page without making a choice
      window.addEventListener('beforeunload', () => {
        if (!choiceMadeOnCookiesPage) {
          clearConsent();
        }
      });
      
      // Also handle navigation within the site
      document.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (link && link.href && !link.href.includes('#') && link.href !== window.location.href) {
          // Small delay to allow choice to be made
          setTimeout(() => {
            if (!choiceMadeOnCookiesPage) {
              clearConsent();
            }
          }, 100);
        }
      });
      
      // Handle browser back/forward
      window.addEventListener('popstate', () => {
        if (!choiceMadeOnCookiesPage) {
          clearConsent();
        }
      });
    }
  })();
</script>

<style>
  @keyframes slide-up {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slide-down {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100%);
      opacity: 0;
    }
  }
  
  .animate-slide-up {
    animation: slide-up 0.3s ease-in-out;
  }
  
  .animate-slide-down {
    animation: slide-down 0.3s ease-in-out;
  }
</style>

